# 项目迁移说明

## 从 Python 到 Next.js 的转换

本文档说明了如何将 Python (tkinter) 桌面应用迁移到 Next.js Web 应用。

## 技术栈对比

### 原 Python 项目
- 语言: Python 3
- GUI: tkinter
- 图片处理: Pillow (PIL)
- HTTP 请求: requests
- 多线程: threading

### 新 Next.js 项目
- 框架: Next.js 14 (App Router)
- 语言: TypeScript
- 样式: Tailwind CSS
- UI 组件: shadcn/ui
- 图标: Lucide React
- 部署: GitHub Actions

## 核心功能映射

### 1. 文件监控

**Python 版本:**
```python
def monitor_file(self):
    while self.is_monitoring:
        if os.path.exists(self.json_file):
            current_mtime = os.path.getmtime(self.json_file)
            if current_mtime > self.last_modified_time:
                self.last_modified_time = current_mtime
                self.process_json_file()
        time.sleep(2)
```

**Next.js 版本:**
```typescript
// API 路由: app/api/check-update/route.ts
export async function GET() {
  const stats = fs.statSync(jsonFilePath)
  const currentModifiedTime = stats.mtimeMs
  const updated = currentModifiedTime > lastModifiedTime
  return NextResponse.json({ updated })
}

// 前端轮询
const interval = setInterval(async () => {
  const response = await fetch('/api/check-update')
  const data = await response.json()
  if (data.updated) {
    await processStore()
  }
}, 2000)
```

### 2. JSON 数据解析

**Python 版本:**
```python
with open(self.json_file, 'r', encoding='utf-8') as f:
    data = json.load(f)

poi_info = data.get('data', {}).get('poi_info', {})
store_name = poi_info.get('name', '未知店铺')
```

**Next.js 版本:**
```typescript
const fileContent = fs.readFileSync(jsonFilePath, 'utf-8')
const data: JsonData = JSON.parse(fileContent)

const poiInfo = data.data?.poi_info || {}
const storeName = poiInfo.name || '未知店铺'
```

### 3. 图片提取逻辑

**Python 版本:**
```python
def remove_size_params(self, url):
    if not url:
        return url
    return re.sub(r'@\d+w_\d+h_\d+e_\d+c', '', url)

# 提取头像
avatar_url = self.remove_size_params(poi_info.get('pic_url', ''))
```

**Next.js 版本:**
```typescript
function removeSizeParams(url: string): string {
  if (!url) return url
  return url.replace(/@\d+w_\d+h_\d+e_\d+c/g, '')
}

const avatarUrl = removeSizeParams(poiInfo.pic_url || '')
```

### 4. UI 界面

**Python tkinter:**
```python
self.avatar_label = tk.Label(
    frame,
    text="暂无图片",
    bg='#f8f9fa',
    fg='#6c757d'
)
```

**Next.js + Tailwind:**
```tsx
<Card className="bg-slate-800/50 border-slate-700">
  <CardHeader>
    <CardTitle className="text-white">店铺头像</CardTitle>
  </CardHeader>
  <CardContent>
    {avatarLoaded ? (
      <img src={storeInfo.avatarUrl} alt="店铺头像" />
    ) : (
      <span className="text-gray-500">暂无图片</span>
    )}
  </CardContent>
</Card>
```

## 架构差异

### Python 架构
```
monitor.py (单文件)
├── ImageMonitorApp 类
│   ├── setup_ui() - UI 初始化
│   ├── monitor_file() - 文件监控 (线程)
│   ├── process_json_file() - 数据处理
│   ├── download_and_display() - 图片下载
│   └── display_image() - 图片显示
```

### Next.js 架构
```
meituan-image-monitor/
├── app/
│   ├── page.tsx - 主页面 UI + 监控逻辑
│   ├── layout.tsx - 根布局
│   └── api/
│       ├── check-update/ - 文件检测 API
│       └── extract-images/ - 数据提取 API
├── components/ui/ - UI 组件库
└── lib/utils.ts - 工具函数
```

## 主要改进

### 1. 跨平台支持
- Python: 需要安装 Python 和依赖,仅桌面端
- Next.js: 浏览器访问,支持移动端,可部署云端

### 2. 部署便捷性
- Python: 需要打包 exe 或分发源码
- Next.js: 一键部署到 Vercel/GitHub Pages

### 3. 界面体验
- Python: 原生窗口,风格固定
- Next.js: 现代化 Web UI,响应式设计,支持暗色主题

### 4. 可扩展性
- Python: 单文件应用,扩展需要重构
- Next.js: 模块化架构,易于添加新功能

## 功能对比

| 功能 | Python 版本 | Next.js 版本 | 备注 |
|------|------------|-------------|------|
| 实时监控 | ✅ | ✅ | 均为轮询方式 |
| 图片预览 | ✅ | ✅ | Next.js 更美观 |
| 图片下载保存 | ✅ | ❌ | Next.js 版本待实现 |
| 日志显示 | ✅ | ✅ | 功能相同 |
| 启动/停止 | ✅ | ✅ | 功能相同 |
| 移动端支持 | ❌ | ✅ | Next.js 独有 |
| 云端部署 | ❌ | ✅ | Next.js 独有 |
| 多用户访问 | ❌ | ✅ | Next.js 独有 |

## 迁移步骤

### 1. 创建 Next.js 项目
```bash
npx create-next-app@latest meituan-image-monitor
cd meituan-image-monitor
```

### 2. 安装依赖
```bash
npm install lucide-react class-variance-authority clsx tailwind-merge
npm install -D tailwindcss-animate
```

### 3. 配置 Tailwind
- 复制 `tailwind.config.ts`
- 复制 `app/globals.css`

### 4. 创建 UI 组件
- 复制 `components/ui/` 目录下的所有组件

### 5. 实现核心逻辑
- 创建 API 路由
- 实现前端页面
- 连接前后端

### 6. 测试
```bash
npm run dev
```

### 7. 部署
```bash
# 推送到 GitHub
git push

# 或部署到 Vercel
vercel
```

## 注意事项

### 文件路径
Next.js API 路由运行在服务器端,需要使用 Node.js 的 `fs` 模块读取文件:

```typescript
import fs from 'fs'
import path from 'path'

const jsonFilePath = path.join(process.cwd(), '..', 'latest_poi_food.json')
```

### CORS 问题
如果图片 URL 有跨域限制,需要配置 `next.config.js`:

```javascript
module.exports = {
  images: {
    remotePatterns: [
      { protocol: 'http', hostname: 'p0.meituan.net' },
      { protocol: 'http', hostname: 'p1.meituan.net' },
    ],
  },
}
```

### 性能优化
- 使用 Next.js 的 Image 组件优化图片加载
- 考虑使用 WebSocket 替代轮询
- 添加图片缓存机制

## 未来改进方向

1. **图片下载功能**
   - 添加下载按钮
   - 支持批量下载
   - 保存到用户本地

2. **数据持久化**
   - 使用数据库存储历史记录
   - 支持数据导出

3. **实时通信**
   - 使用 WebSocket 替代轮询
   - 更快的更新响应

4. **用户管理**
   - 添加用户认证
   - 支持多用户协作

5. **统计分析**
   - 添加数据统计图表
   - 店铺对比功能

## 总结

从 Python 桌面应用迁移到 Next.js Web 应用,核心业务逻辑保持不变,但获得了:
- ✅ 更好的跨平台支持
- ✅ 更容易的部署方式
- ✅ 更现代的用户界面
- ✅ 更强的可扩展性

适合需要在团队中共享使用或需要云端部署的场景。
