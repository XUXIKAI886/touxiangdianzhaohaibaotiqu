# 外卖平台图片提取系统 (美团 & 饿了么)

<div align="center">

![Next.js](https://img.shields.io/badge/Next.js-14.2-black?style=for-the-badge&logo=next.js)
![TypeScript](https://img.shields.io/badge/TypeScript-5.0-blue?style=for-the-badge&logo=typescript)
![Tailwind CSS](https://img.shields.io/badge/Tailwind-3.4-38bdf8?style=for-the-badge&logo=tailwind-css)
![Version](https://img.shields.io/badge/Version-v2.0-brightgreen?style=for-the-badge)
![License](https://img.shields.io/badge/License-MIT-green?style=for-the-badge)

一个基于 Next.js 的多平台图片提取系统，支持美团外卖店铺图片和饿了么商品图片的自动提取、实时监控和批量下载。

**✨ v2.0 新特性**：内容哈希检测、智能去重、Tauri桌面应用支持、批量下载优化

[功能特性](#-功能特性) • [技术栈](#️-技术栈) • [快速开始](#-快速开始) • [使用说明](#-使用说明) • [v2.0更新](#-v20-重大更新) • [常见问题](#-常见问题-faq)

</div>

---

## 🎉 v2.0 重大更新

### 🚀 核心优化

#### 1. **智能文件内容检测** 🎯
- ✅ **内容哈希算法**：使用哈希值检测文件真实变化，而非简单的修改时间
- ✅ **防止频繁误触发**：即使文件修改时间每2秒变化，内容未变也不会重复提取
- ✅ **精确检测**：只有文件内容真正改变时才触发数据提取

#### 2. **优化的监控策略** 📊
- ✅ **首次选择文件不提取**：选择文件后等待内容变化，避免加载旧数据
- ✅ **清空数据智能暂停**：清空后跳过一次更新，下次内容变化才恢复提取
- ✅ **商品监控同步优化**：商品文件监控应用相同的智能策略

#### 3. **Tauri 桌面应用完美支持** 💻
- ✅ **原生文件下载**：使用 Tauri 2.x 官方 API 实现文件保存
- ✅ **批量下载优化**：只需选择一次文件夹，所有图片自动保存
- ✅ **跨平台兼容**：同一套代码在浏览器和桌面应用中无缝运行

#### 4. **用户体验增强** ✨
- ✅ **版本标识**：界面显示明显的版本徽章，方便确认更新状态
- ✅ **详细日志**：控制台输出完整的调试信息和操作追踪
- ✅ **智能提示**：根据不同场景显示上下文相关的操作提示

---

## 📸 系统预览

本系统提供两个独立的子系统，分别用于美团和饿了么平台的图片提取：

### 🏠 主页
- 🎯 平台选择入口
- 📱 响应式卡片布局
- 🎨 渐变主题设计
- 🔖 **v2.0版本标识**

### 🍊 美团系统 (v2.0)
- 🏪 **店铺信息提取**：头像、店招、海报（原图质量）
- 🧠 **智能内容检测**：哈希算法精确识别文件变化
- ⏱️ **实时文件监控**：2秒轮询，内容变化自动提取
- 📋 **彩色分类日志**：成功/错误/警告/信息
- 💾 **批量下载优化**：Tauri环境只需选择一次文件夹
- 📚 **历史记录**：保存最近10条，支持快速切换
- 🖱️ **店铺名称一键复制**：当前与历史记录中的店铺名称均可点击复制
- 🎨 **版本徽章**：界面显示"v2.0-内容哈希检测"

### 🔵 饿了么系统
- 🛒 **商品信息提取**：商品名称、商品图片
- 📂 **浏览器文件选择器**：File System Access API
- 🔄 **自动文件监控**：2秒轮询，智能内容检测
- 🎯 **商品名称自动去重**：保留最新记录
- 📦 **批量下载**：图片以商品名称命名

---

## ✨ 功能特性

### 🍊 美团外卖系统 (v2.0)

#### 🎯 核心功能（已升级）
- ✅ **智能文件监控**
  - 每2秒检测文件变化
  - **v2.0**：使用内容哈希而非修改时间
  - 防止频繁误触发，精确识别真实变化

- ✅ **首次选择不提取**
  - 选择文件后等待内容变化
  - 避免加载可能过时的初始数据
  - 确保提取的是最新信息

- ✅ **清空数据智能暂停**
  - 清空后跳过一次文件更新
  - 下次内容真正变化时才恢复提取
  - 避免意外重复加载相同数据

- ✅ **智能数据解析**
  - 支持 `poi_info` 和 `poi_base_info` 两种 JSON 格式
  - 自动识别并使用可用格式

- ✅ **店铺图片提取**
  - 自动提取店铺头像、店招、海报图片
  - 去除美团图片尺寸参数，获取原图
  - 过滤粉丝群海报等无关图片

- ✅ **实时预览**
  - 图片加载完成后立即显示
  - 支持多海报轮播切换
  - 自动清空旧图片预览

- ✅ **智能下载**
  - **浏览器环境**：使用传统 `<a>` 标签下载
  - **Tauri环境**：使用原生 API 实现文件保存
  - **批量下载优化**：Tauri中只需选择一次文件夹
  - 自动以店铺名称命名：`店铺名_头像.jpg`
  - 处理文件名非法字符：`<>:"/\|?*` → `_`

- ✅ **历史记录**
  - 保存最近10条店铺记录
  - 自动去重（相同店铺ID只保留最新）
  - 支持快速切换历史店铺
- ✅ **店铺名称一键复制**
  - 当前店铺名称支持点击即可复制，并有状态反馈
  - 历史记录提供独立复制按钮，避免误加载

#### 💻 Tauri 桌面应用支持
- ✅ **原生文件保存**
  - 使用 `plugin:dialog|save` 显示原生保存对话框
  - 使用 `plugin:fs|write_file` 实现文件写入
  - 完美兼容 Tauri 2.x 的 3 参数 invoke 格式

- ✅ **批量下载优化**
  - 使用 `plugin:dialog|open` 的文件夹选择模式
  - 一次选择文件夹，自动批量保存所有图片
  - 无需为每张图片重复选择位置

- ✅ **跨环境兼容**
  - 自动检测运行环境（浏览器 / Tauri）
  - 根据环境选择最佳下载方式
  - 同一套代码无缝运行

#### 🎨 UI 特色
- 🎨 **橙黄渐变主题** - 灵感来自美团品牌色
- 🌓 **深色模式支持** - 自动适配系统主题
- 📱 **响应式布局** - 完美支持桌面端和移动端
- 🔄 **实时日志** - 彩色分类日志（成功/错误/警告/信息）
- 🏷️ **版本标识** - 控制面板显示 "v2.0-内容哈希检测" 徽章

### 🔵 饿了么系统

#### 核心功能
- ✅ **文件选择器** - 支持浏览器原生文件选择（推荐路径：`D:\ailun\xiaochengxueleme.txt`）
- ✅ **智能文件监控** - 选择文件后自动启动监控，使用内容哈希检测变化
- ✅ **商品数据提取** - 从 JSON 提取商品名称和商品图片
- ✅ **imageHash 转换** - 自动将 imageHash 转换为完整 CDN URL
- ✅ **智能去重** - 根据商品名称自动去重，保留最新记录
- ✅ **实时预览** - 网格布局展示商品图片
- ✅ **批量下载** - 选择文件夹，批量保存所有商品图片
- ✅ **文件名命名** - 图片以商品名称命名，自动处理非法字符
- ✅ **运行日志** - 固定高度日志面板，详细记录操作过程

#### 技术亮点
- 🎯 **File System Access API** - 浏览器原生文件访问（需 Chrome 86+）
- 🖼️ **Canvas API** - 绕过 CORS 限制实现跨域图片下载
- 🔗 **URL 格式转换** - `imageHash` → `https://cube.elemecdn.com/{dir1}/{dir2}/{filename}.{ext}`
- 🎨 **蓝色渐变主题** - 区别于美团的橙色主题

---

## 🛠️ 技术栈

### 前端框架
- **[Next.js 14](https://nextjs.org/)** - React 全栈框架，使用 App Router
- **[React 18](https://react.dev/)** - 用户界面库
- **[TypeScript](https://www.typescriptlang.org/)** - 类型安全的 JavaScript 超集

### 样式设计
- **[Tailwind CSS](https://tailwindcss.com/)** - 实用优先的 CSS 框架
- **[shadcn/ui](https://ui.shadcn.com/)** - 高质量的 React 组件库
- **[Lucide React](https://lucide.dev/)** - 精美的图标库

### 核心技术
- **File System Access API** - 浏览器文件系统访问
- **Canvas API** - 图片处理和跨域下载
- **localStorage** - 本地数据存储（美团历史记录）
- **React Hooks** - 状态管理和副作用处理
- **内容哈希算法** - 精确检测文件内容变化

### Tauri 集成
- **Tauri 2.x** - 跨平台桌面应用框架
- **tauri-plugin-dialog** - 原生文件对话框
- **tauri-plugin-fs** - 原生文件系统访问
- **WebView** - 嵌入式浏览器引擎

---

## 🚀 快速开始

### 环境要求
- **Node.js** >= 18.0.0
- **npm** >= 9.0.0
- **浏览器**
  - 现代浏览器（美团系统）
  - Chrome 86+ / Edge 86+（饿了么系统，需要 File System Access API）
- **Tauri** 2.x（可选，用于桌面应用）

### 安装步骤

#### 1. 克隆项目
```bash
git clone https://github.com/XUXIKAI886/touxiangdianzhaohaibaotiqu.git
cd touxiangdianzhaohaibaotiqu
```

#### 2. 安装依赖
```bash
npm install
```

#### 3. 启动开发服务器

**重要**：每次启动前必须先检查并释放端口！

```bash
# 第一步：检查 3000 端口占用
netstat -ano | findstr :3000

# 第二步：如果端口被占用，强制终止进程
taskkill /F /PID <进程ID>

# 第三步：启动开发服务器
npm run dev
```

服务器将在 [http://localhost:3000](http://localhost:3000) 启动。

#### 4. Windows 快速启动

双击 `start.bat` 文件，自动安装依赖并启动服务器（已包含端口检查）。

---

## 📖 使用说明

### 🍊 美团外卖系统使用指南 (v2.0)

#### 完整使用流程

##### 1. 准备工作
- ✅ 启动 **Fiddler** 并确保脚本配置正确
- ✅ 启动本系统（访问 http://localhost:3000 或 Tauri 应用）
- ✅ 点击 **"美团外卖"** 卡片进入美团系统

##### 2. 选择文件（首次不提取）
- 📂 点击 **"选择文件"** 按钮
- 📄 选择 Fiddler 保存的 JSON 文件
- ⏳ **重要**：首次选择文件不会立即提取数据
- 💡 系统显示："等待文件内容变化..."

##### 3. 等待文件更新
- 📱 在手机美团 APP 中浏览店铺
- 🔄 Fiddler 抓取新数据并写入 JSON 文件
- ✨ **v2.0 智能检测**：
  - 文件修改时间变化但内容未变 → 跳过（不提取）
  - 文件内容真正变化 → 自动提取店铺图片

##### 4. 查看提取结果
- 🏪 店铺信息：名称、ID、更新时间
- 🖼️ 图片预览：头像、店招、海报（多张海报支持轮播）
- 📋 彩色日志：详细记录提取过程

##### 5. 下载图片

**浏览器环境**：
- 单张下载：点击图片下方的下载按钮
- 批量下载：点击"批量下载全部"，每张图片需选择保存位置

**Tauri 桌面应用**：
- 单张下载：点击下载按钮，选择保存位置
- **批量下载优化**：
  1. 点击"批量下载全部"
  2. **只需选择一次文件夹**
  3. 所有图片自动保存到该文件夹
  4. 文件名格式：`店铺名_头像.jpg`、`店铺名_海报1.jpg`

##### 6. 清空数据（智能暂停）
- 🗑️ 点击 **"清空数据"** 按钮
- ⏸️ **v2.0 智能暂停**：
  - 监控继续运行
  - 跳过下一次文件内容变化
  - 再次内容变化时才恢复提取
  - 避免意外重复加载相同数据

##### 7. 历史记录
- 📚 最多保存 10 条历史记录
- 🔄 自动去重（相同店铺 ID 只保留最新）
- 🔙 点击历史记录快速加载

#### 控制台调试日志

**v2.0 新增日志**：
```
🎯🎯🎯 页面版本: v2.0 - 内容哈希检测版本 🎯🎯🎯
✅ 如果看到这条消息，说明已加载新版本代码
📌 保存初始内容哈希: 12345
🔍 内容哈希检查: {当前哈希: "12345", 上次哈希: "12345", 内容是否变化: false}
⏭️ 文件修改时间变化但内容未变，跳过处理
```

---

### 🔵 饿了么系统使用指南

#### 启动监控流程
1. **启动 Fiddler** 并配置保存路径为 `D:\ailun\xiaochengxueleme.txt`
2. **启动本系统**（访问 http://localhost:3000）
3. **点击"饿了么"卡片** 进入饿了么系统
4. **点击"选择监控文件"按钮**
5. **在弹出的文件选择器中**：
   - 在地址栏输入：`D:\ailun\`
   - 按 Enter 键快速跳转
   - 选择 `xiaochengxueleme.txt` 文件
6. **系统自动开始监控**（文件选择后自动启动）
7. **打开手机饿了么 APP**，浏览店铺商品
8. **系统自动检测** 文件更新并提取商品图片
9. **批量下载** 选择文件夹保存所有图片

#### 图片命名规则
下载的图片文件名格式：
- **格式**：`{商品名称}.jpg`
- **示例**：`霸气橙子-[大杯650ml].jpg`
- **非法字符处理**：自动将 `<>:"/\|?*` 替换为 `_`

---

## 🔄 平台对比

| 特性 | 美团外卖系统 (v2.0) | 饿了么系统 |
|------|-------------------|-----------|
| **提取内容** | 店铺头像、店招、海报 | 商品名称、商品图片 |
| **文件选择** | JSON文件上传 | 浏览器文件选择器 |
| **监控方式** | 内容哈希智能检测 | 内容哈希智能检测 |
| **首次选择** | 等待内容变化 | 等待内容变化 |
| **去重策略** | 店铺 ID 去重 | 商品名称去重 |
| **下载命名** | `店铺名_类型.jpg` | `商品名称.jpg` |
| **批量下载** | Tauri环境只选一次文件夹 | 选择文件夹批量保存 |
| **历史记录** | ✅ 支持（最多10条） | ❌ 不支持 |
| **清空暂停** | ✅ 智能跳过一次更新 | ✅ 智能跳过一次更新 |
| **主题配色** | 🍊 橙黄渐变 | 🔵 蓝青渐变 |
| **浏览器要求** | 现代浏览器 | Chrome 86+ / Edge 86+ |
| **Tauri支持** | ✅ 完美支持 | ✅ 完美支持 |

---

## 📁 项目结构

```
touxiangdianzhaohaibaotiqu/
├── app/                          # Next.js App Router 目录
│   ├── page.tsx                  # 🏠 主页 - 平台选择入口
│   ├── meituan/                  # 🍊 美团外卖系统 (v2.0)
│   │   └── page.tsx              # 美团系统主页面（1400+ 行）
│   ├── eleme/                    # 🔵 饿了么系统
│   │   └── page.tsx              # 饿了么系统主页面
│   ├── layout.tsx                # 根布局组件
│   ├── globals.css               # 全局样式
│   └── favicon.ico               # 网站图标
│
├── components/                   # React 组件
│   └── ui/                       # shadcn/ui 组件库
│
├── public/                       # 静态资源
│   └── .nojekyll                 # GitHub Pages 配置
│
├── .github/workflows/            # GitHub Actions
│   └── deploy.yml                # 自动部署脚本
│
├── next.config.js                # Next.js 配置（静态导出）
├── package.json                  # 项目依赖配置
├── CLAUDE.md                     # Claude Code 项目指南
├── DOWNLOAD_FIX_SUMMARY.md       # Tauri下载修复总结
└── README.md                     # 📖 项目说明文档
```

---

## 🔍 常见问题 (FAQ)

### Q1: 为什么选择文件后没有立即显示图片？
**A:** 这是 **v2.0 的新特性**！
- ✅ 首次选择文件时，系统**不会立即提取数据**
- ✅ 系统等待文件内容真正变化后才提取
- ✅ 避免加载可能过时的初始数据
- 💡 在手机 APP 中浏览新店铺，Fiddler 抓取到新数据后会自动提取

### Q2: 文件明明变化了，为什么没有提取数据？
**A:** 可能是以下情况：
1. **刚清空数据**：清空后会跳过一次文件更新，下次才恢复提取
2. **内容未真正变化**：v2.0 检测文件内容而非修改时间，即使修改时间变化，内容相同也不会提取
3. **查看控制台日志**：打开 F12 查看详细的哈希检查日志

### Q3: Tauri 应用中批量下载为什么每张图片都要选择位置？
**A:** 您可能加载了旧版本代码！
- ✅ **v2.0 新特性**：批量下载只需选择一次文件夹
- 🔄 **强制刷新**：在 Tauri 应用中按 `Ctrl + Shift + R`
- 🧹 **清除缓存**：F12 → Application → Clear site data
- ✅ **确认版本**：看到绿色"v2.0-内容哈希检测"徽章表示已更新

### Q4: 如何确认是否加载了 v2.0 版本？
**A:** 有两种方式确认：

**方式1：查看界面**
- 控制面板标题旁边应该有绿色徽章：**v2.0-内容哈希检测**

**方式2：查看控制台**
```
🎯🎯🎯 页面版本: v2.0 - 内容哈希检测版本 🎯🎯🎯
```

### Q5: 饿了么系统为什么无法选择文件？
**A:** 请确认使用 **Chrome 86+** 或 **Edge 86+** 浏览器。

### Q6: 图片下载后无法打开？
**A:** 可能原因：
1. 美团图片 URL 已失效（定期清理）
2. 网络连接问题
3. CORS 跨域限制

### Q7: 端口被占用怎么办？
**A:** 执行以下命令：
```bash
# Windows
netstat -ano | findstr :3000
taskkill /F /PID <进程ID>

# Linux/macOS
lsof -ti:3000 | xargs kill -9
```

### Q8: 为什么文件修改时间一直在变化？
**A:** 可能是：
1. **Fiddler 实时写入模式**：每 2 秒刷新文件
2. **其他脚本监控**：有脚本在定期更新文件
3. **v2.0 已解决**：使用内容哈希检测，修改时间变化但内容不变时不会触发提取

### Q9: 清空数据后为什么还在提取？
**A:** 这是 **v2.0 的智能暂停机制**：
- ✅ 清空后跳过**一次**文件内容变化
- ✅ 下次内容变化时自动恢复提取
- 💡 这样设计是为了避免意外重复加载相同数据

### Q10: Tauri 应用中的缓存问题
**A:** Tauri 的 WebView 缓存非常顽固，需要：
1. **F12** 打开开发者工具
2. **Application** → **Clear site data**
3. **Network** → **勾选 Disable cache**
4. **Ctrl + Shift + R** 硬刷新
5. 或者完全关闭并重启 Tauri 应用

---

## 📦 部署

### GitHub Pages 部署（已配置）

推送代码到 master 分支，GitHub Actions 自动部署：

```bash
git add .
git commit -m "更新功能"
git push origin master
```

访问：`https://xuxikai886.github.io/touxiangdianzhaohaibaotiqu`

**部署流程**：
1. GitHub Actions 自动触发
2. 执行 `npm run build` 构建静态网站
3. 上传 `out` 目录到 GitHub Pages
4. 约 2-3 分钟后生效

**注意事项**：
- ✅ 确保仓库设置中启用了 GitHub Pages
- ✅ Source 设置为：**GitHub Actions**
- ✅ `next.config.js` 中的 `basePath` 与仓库名一致

---

## 🔧 开发指南

### 本地开发

```bash
npm run dev        # 启动开发服务器 (http://localhost:3000)
npm run build      # 构建静态网站到 out 目录
npm run lint       # 运行 ESLint 代码检查
```

### 静态网站预览

```bash
npm run build      # 先构建
npx serve out      # 预览 out 目录
```

### Tauri 应用集成

本项目可以被任何 Tauri 应用通过 iframe 加载：

```html
<iframe src="https://xuxikai886.github.io/touxiangdianzhaohaibaotiqu/meituan" />
```

**Tauri 权限配置**（参考）：
```json
{
  "permissions": [
    "dialog:allow-save",
    "dialog:allow-open",
    "fs:allow-write-file"
  ]
}
```

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

### 提交规范
- `feat:` 新功能
- `fix:` 修复 bug
- `docs:` 文档更新
- `style:` 代码格式调整
- `refactor:` 重构代码
- `perf:` 性能优化
- `test:` 测试相关

### 开发建议
- 遵循现有的代码风格
- 添加详细的注释（中文）
- 更新相关文档

---

## 📄 许可证

MIT License

---

## 🙏 致谢

- **Next.js** - 强大的 React 框架
- **Tauri** - 轻量级的桌面应用框架
- **shadcn/ui** - 精美的组件库
- **Claude Code** - AI 辅助开发工具

---

<div align="center">

**⭐ 如果这个项目对你有帮助，请给个 Star！**

Made with ❤️ using Next.js 14 & Tauri 2.x

**🆕 当前版本：v2.0 - 内容哈希检测版**

🤖 Generated with [Claude Code](https://claude.com/claude-code)

---

### 📊 版本历史

**v2.0** (2025-10-18)
- ✨ 新增内容哈希检测算法
- ✨ 优化 Tauri 桌面应用支持
- ✨ 批量下载只需选择一次文件夹
- ✨ 首次选择文件不提取数据
- ✨ 清空数据智能暂停提取
- 🐛 修复频繁误触发问题

**v1.0** (2025-10-15)
- 🎉 初始版本发布
- ✅ 美团外卖图片提取
- ✅ 饿了么商品图片提取
- ✅ 实时文件监控
- ✅ GitHub Pages 部署

</div>
